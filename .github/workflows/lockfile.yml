name: Lockfile Maintenance
on:
  workflow_call:
    inputs:
      package-manager:
        type: string
        required: true
        default: npm
        description: The package manager used in the repository, either "npm" or "yarn".

env:
  NODE_VERSION: 18.x
  RUNNER_OS: linux
  RUNNER_ARCH: x64

jobs:
  maintenance:
    name: Lockfile maintenance with Node.js 18.x
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 🛎️ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.REPO_TOKEN }}

      - name: 🔍 Validate Package Manager
        run: |
          if [ ${{ inputs.package-manager }} != 'npm' ] && [ ${{ inputs.package-manager }} != 'yarn' ]; then
            echo "Package manager not supported, exiting..."
            exit 1
          else
            echo "Package manager detected: ${{ inputs.package-manager }}"
          fi

      - name: 📁 Get NPM Cache Directory
        id: npm-cache-dir
        if: inputs.package-manager == 'npm'
        run: |
          npm config get cache
          echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: 📁 Get Yarn Cache Directory
        id: yarn-cache-dir
        if: inputs.package-manager == 'yarn'
        run: |
          yarn cache dir
          echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - name: ☁️ Restore NPM Cache
        if: inputs.package-manager == 'npm'
        uses: actions/cache@v3
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: node-cache-${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: node-cache-${{ runner.os }}-npm-

      - name: ☁️ Restore Yarn Cache
        if: inputs.package-manager == 'yarn'
        uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: node-cache-${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: node-cache-${{ runner.os }}-yarn-

      - name: ⚙️ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 📦 Install Dependencies
        run: |
          if [ ${{ inputs.package-manager }} == 'npm' ]; then
            npm ci --cache ${{ steps.npm-cache-dir.outputs.dir }} --prefer-offline
          elif [ ${{ inputs.package-manager }} == 'yarn' ]; then
            yarn install --frozen-lockfile
          fi

      - name: ⬆️ Update Lockfile
        run: ${{ inputs.package-manager }} upgrade

      - name: 🔍 Check Lockfile Changes
        id: status
        run: |
          if [ $(git status --porcelain | wc -l) == "0" ]; then
            echo "No lockfile changes detected, exiting..."
            echo "STATUS=0" >> $GITHUB_OUTPUT
          else
            git status --porcelain
            echo "STATUS=1" >> $GITHUB_OUTPUT
          fi

      - name: ⬆️ Update Version
        id: bump
        run: |
          npm pkg get version
          CURRENT_VERSION=$(npm pkg get version | tr -d '"')
          echo "CURRENT_VERSION=$CURRENT_VERSION"
          git rev-list --count HEAD
          GIT_COUNT=$(git rev-list --count HEAD)
          echo "GIT_COUNT=$GIT_COUNT"
          MAJOR=$(expr $(( $GIT_COUNT )) / 1000)
          echo "MAJOR=$MAJOR"
          MINOR=$(expr $(( $GIT_COUNT )) % 1000 / 100)
          echo "MINOR=$MINOR"
          PATCH=$(expr $(( $GIT_COUNT )) % 1000 % 100 + 1)
          echo "PATCH=$PATCH"
          NEW_VERSION=$MAJOR.$MINOR.$PATCH
          echo "NEW_VERSION=$NEW_VERSION"
          if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
            echo "Current version is different from new version." >>
            if [ ${{ inputs.package-manager }} == 'npm' ]; then
              npm version $NEW_VERSION --git-tag-version false
            elif [ ${{ inputs.package-manager }} == 'yarn' ]; then
              yarn version --new-version $NEW_VERSION --no-git-tag-version
            fi
          fi
        shell: bash

      - name: 🚀 Push Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git status
          git commit -m "chore(deps): v${{ steps.bump.outputs.VERSION }} - lockfile maintenance"
          git pull --rebase
          # git push
